{
    "$id": "https://bsgip.com/e-json",
    "$schema": "https://json-schema.org/draft/2020-12/schema",
    "display_name": "e-JSON Schema",
    "type": "object",
    "description": "JSON schema for the e-JSON data format that represents electrical networks",
    "properties": {
        "ejson_version": {
            "type": "string",
            "description": "Version number in the form a.b.c. Versions start at 1.0; a increments at major breaking changes, b increments at minor breaking changes, and c increments for non-breaking changes",
            "pattern": "[0-9]+.[0-9]+.[0.9]+",
            "examples": ["1.0.0"]
        },
        "id": {
            "type": "string",
            "description": "Network ID"
        },
        "user_data": {
            "$ref": "#/$defs/user_data"
        },
        "voltage_type": {
            "type": "string",
            "description": "Voltage type, ll (line to line) or lg (line to ground)",
            "enum": ["ll", "lg"],
            "examples": ["ll", "lg"]
        },
        "components": {
            "type": "array",
            "description": "List of all network components (nodes and elements)",
            "items": {
                "$ref": "#/$defs/component"
            }
        }
    },
    "required": ["voltage_type", "components"],
    "additionalProperties": false,
    "$defs": {
        "positive_number": {
            "type": "number",
            "description": "A positive number",
            "minimum": 0
        },
        "two_number_array": {
            "type": "array",
            "description": "An array containing two numbers",
            "items": {
                "type": "number"
            },
            "minItems": 2,
            "maxItems": 2
        },
        "complex_number": {
            "@ref": "#/$defs/two_number_array",
            "description": "Complex number, stored as [<real>, <imag>]",
            "examples": [[4, 7]]
        },
        "two_positive_number_array": {
            "type": "array",
            "description": "An array containing two positive numbers",
            "items": {
                "$ref": "#/$defs/positive_number"
            },
            "minItems": 2,
            "maxItems": 2
        },
        "two_complex_number_array": {
            "type": "array",
            "description": "An array containing two complex numbers",
            "items": {
                "$ref": "#/$defs/complex_number"
            },
            "minItems": 2,
            "maxItems": 2,
            "examples": [[[1, 2.3], [2.0, 0.0]]]
        },
        "complex_array": {
            "type": "array",
            "description": "An array of complex numbers",
            "items": {
                "$ref": "#/$defs/complex_number"
            },
            "examples": [[[1, 2.3], [2.0, 0.0], [0.0, -1.0]]]
        },
        "complex_matrix": {
            "type": "array",
            "description": "A matrix of complex numbers",
            "items": {
                "$ref": "#/$defs/complex_array"
            },
            "examples": [
                [
                    [[1, 0], [1, 1]],
                    [[0, 1], [1, 1]]
                ],
                [[[1, 0]]]
            ]
        },
        "component_id": {
            "type": "string",
            "description": "The component's unique ID"
        },
        "user_data": {
            "type": "object",
            "description": "Non-e-json annotations"
        },
        "phs": {
            "type": "array",
            "description": "A list of phases",
            "minItems": 1,
            "items": {
                "type": "string"
            },
            "examples": [["A"], ["A", "B", "C"]]
        },
        "connection": {
            "type": "object",
            "description": "A list of connections from element terminals. Each connection gives the node ID and phases to which the element is connected",
            "properties": {
                "node": {
                    "type": "string"
                },
                "phs": {
                    "$ref": "#/$defs/phs"
                }
            },
            "required": ["node", "phs"],
            "examples": [[{"node": "node_1", "phs": ["A", "C"]}, {"node": "node_2", "phs": ["A", "B", "C"]}]]
        },
        "one_connection": {
            "type": "array",
            "description": "A one element list of connections",
            "minItems": 1,
            "maxItems": 1,
            "items": {
                "$ref": "#/$defs/connection"
            },
            "examples": [[{"node": "node_1", "phs": ["A", "C"]}]]
        },
        "two_connections": {
            "type": "array",
            "description": "A two element list of connections",
            "minItems": 2,
            "maxItems": 2,
            "items": {
                "$ref": "#/$defs/connection"
            },
            "examples": [[{"node": "node_1", "phs": ["A", "C"]}, {"node": "node_2", "phs": ["A", "B", "C"]}]]
        },
        "two_or_more_connections": {
            "type": "array",
            "description": "A list of connections with at least 2 elements",
            "minItems": 2,
            "items": {
                "$ref": "#/$defs/connection"
            },
            "examples": [[{"node": "node_1", "phs": ["A", "C"]}, {"node": "node_2", "phs": ["A", "B", "C"]}]]
        },
        "wiring": {
            "type": "string",
            "description": "Specification of load or transformer wiring; delta (LL) or wye (LG)",
            "enum": ["delta", "wye"]
        },
        "in_service": {
            "type": "boolean",
            "description": "If false, the component is out of service",
            "default": true
        },
        "component": {
            "type": "object",
            "description": "A component (Node/Infeeder/Gen/Load/Connector/Transformer)",
            "oneOf": [
                {
                    "$ref": "#/$defs/Node"
                },
                {
                    "$ref": "#/$defs/Infeeder"
                },
                {
                    "$ref": "#/$defs/Gen"
                },
                {
                    "$ref": "#/$defs/Load"
                },
                {
                    "$ref": "#/$defs/Line"
                },
                {
                    "$ref": "#/$defs/Connector"
                },
                {
                    "$ref": "#/$defs/Transformer"
                }
            ]
        },
        "Node": {
            "type": "object",
            "description": "A network node (bus)",
            "properties": {
                "id": {
                    "$ref": "#/$defs/component_id"
                },
                "type": {
                    "const": "Node"
                },
                "phs": {
                    "$ref": "#/$defs/phs"
                },
                "user_data": {
                    "$ref": "#/$defs/user_data"
                },
                "v": {
                    "$ref": "#/$defs/complex_array",
                    "description": "The current voltage in V for each phase, line to line or line to ground according to global voltage_type"
                },
                "v_base": {
                    "$ref": "#/$defs/positive_number",
                    "description": "The base voltage in V for the node, line to line or line to ground according to global voltage_type"
                },
                "lat_long": {
                    "ref": "#/$defs/two_number_array",
                    "description": "[latitude, longitude]"
                },
                "xy": {
                    "ref": "#/$defs/two_number_array",
                    "description": "Coordinates [x, y] e.g. for map datum"
                }
            },
            "required": ["id", "type", "phs", "v_base"],
            "additionalProperties": false
        },
        "Infeeder": {
            "type": "object",
            "description": "Network infeeder with constant voltage",
            "properties": {
                "id": {
                    "$ref": "#/$defs/component_id"
                },
                "type": {
                    "const": "Infeeder"
                },
                "cons": {
                    "$ref": "#/$defs/one_connection"
                },
                "user_data": {
                    "$ref": "#/$defs/user_data"
                },
                "in_service": {"$ref": "#/$defs/in_service"},
                "v_setpoint": {
                    "$ref": "#/$defs/positive_number",
                    "description": "Voltage magnitude setpoint in V, line to line or line to ground according to global voltage_type"
                },
                "i_max": {
                    "type": ["number", "null"],
                    "description": "maximum current per phase, in A"
                }
            },
            "required": ["id", "type", "cons", "v_setpoint"],
            "additionalProperties": false
        },
        "Gen": {
            "type": "object",
            "description": "A generator, with optional voltage control",
            "properties": {
                "id": {
                    "$ref": "#/$defs/component_id"
                },
                "type": {
                    "const": "Generator"
                },
                "cons": {
                    "$ref": "#/$defs/one_connection"
                },
                "user_data": {
                    "$ref": "#/$defs/user_data"
                },
                "in_service": {"$ref": "#/$defs/in_service"},
                "wiring": {
                    "$ref": "#/$defs/wiring"
                },
                "p_min": {
                    "type": "number",
                    "description": "Minimum real power injection in W, (generation convention). "
                },
                "p_max": {
                    "type": "number",
                    "description": "Maximum real power injection in W, (generation convention).",
                    "default": 0
                },
                "q_min": {
                    "type": "number",
                    "description": "Minimum reactive power injection in VA (generation convention). "
                },
                "q_max": {
                    "type": "number",
                    "description": "Maximum reactive power injection in VA (generation convention).",
                    "default": 0
                },
                "cost": {
                    "type": "number",
                    "description": "Cost, in (cost unit) per Wh",
                    "default": 0
                },
                "fixed_voltage": {
                    "type": "boolean",
                    "description": "If true, the voltage magnitude is maintained at the setpoint.",
                    "default": false
                },
                "v_setpoint": {
                    "type": "number",
                    "description": "Voltage magnitude setpoint in V, line to line or line to ground according to global voltage_type"
                },
                "is_reference": {
                    "type": "boolean",
                    "description": "If true, the voltage angle is referenced to zero.",
                    "default": false
                }
            },
            "required": ["id", "type", "cons", "wiring"]
        },
        "Load": {
            "type": "object",
            "description": "A load",
            "properties": {
                "id": {
                    "$ref": "#/$defs/component_id"
                },
                "type": {
                    "const": "Load"
                },
                "cons": {
                    "$ref": "#/$defs/one_connection"
                },
                "user_data": {
                    "$ref": "#/$defs/user_data"
                },
                "wiring": {
                    "$ref": "#/$defs/wiring"
                },
                "s": {
                    "type": "array",
                    "items": {
                        "$ref": "#/$defs/complex_number"
                    },
                    "minItems": 1
                }
            },
            "required": ["id", "type", "cons"]
        },
        "line_impedance_z_z0": {
            "type": "object",
            "properties": {
                "z": {
                    "$ref": "#/$defs/complex_number"
                },
                "z0": {
                    "$ref": "#/$defs/complex_number"
                },
                "b_chg": {
                    "type": "number"
                }
            },
            "required": ["z", "z0"]
        },
        "line_impedance_y_bus": {
            "properties": {
                "y_bus": {
                    "$ref": "#/$defs/complex_matrix"
                }
            },
            "required": ["y_bus"]
        },
        "Line": {
            "type": "object",
            "description": "A line",
            "properties": {
                "id": {
                    "$ref": "#/$defs/component_id"
                },
                "type": {
                    "const": "Line"
                },
                "cons": {
                    "$ref": "#/$defs/two_connections"
                },
                "user_data": {
                    "$ref": "#/$defs/user_data"
                },
                "in_service": {"$ref": "#/$defs/in_service"},
                "i_max": {
                    "type": ["number", "null"]
                },
                "length": {
                    "type": "number"
                }
            },
            "required": ["id", "type", "cons", "length"],
            "oneOf": [
                {
                    "$ref": "#/$defs/line_impedance_z_z0"
                },
                {
                    "$ref": "#/$defs/line_impedance_y_bus"
                }
            ]
        },
        "Connector": {
            "type": "object",
            "description": "An optionally switchable zero impedance connection between terminals",
            "properties": {
                "id": {
                    "$ref": "#/$defs/component_id"
                },
                "type": {
                    "const": "Connector"
                },
                "cons": {
                    "$ref": "#/$defs/two_or_more_connections"
                },
                "user_data": {
                    "$ref": "#/$defs/user_data"
                },
                "in_service": {"$ref": "#/$defs/in_service"},
                "i_max": {
                    "type": ["number", "null"]
                },
                "switch_state": {
                    "enum": ["closed", "open", "no_switch"]
                }
            },
            "required": ["id", "type", "cons"]
        },
        "tap_changer": {
            "type": "object",
            "description": "Tap changer for a Transformer",
            "properties": {
				"voltage_range": {
                    "type": "array",
                    "items": {
						"$ref": "#/$defs/positive_number"
					}
				},
                "indep_taps": {
                    "type": "boolean",
					"default": false
                },
                "winding_side": {
                    "type": "string",
                    "enum": ["primary", "secondary"]
                },
                "winding_idx": {
                    "anyOf": [{
                        "type": "integer",
                        "minimum": 0
                    }, {
                        "type": "string",
                        "const": "avg"
                    }]
                },
                "ctrl": {
                    "type": "string",
                    "enum": ["auto", "manual"],
					"default": "auto"
                },
                "ldc_impedance": {
                    "$ref": "#/$defs/complex_number"
                },
                "delay_seconds": {
                    "type": "number"
                }
            },
            "required": ["voltage_range", "winding_side", "winding_idx"]
        },
        "Transformer": {
            "type": "object",
            "description": "A transformer",
            "properties": {
                "id": {
                    "$ref": "#/$defs/component_id"
                },
                "type": {
                    "const": "Transformer"
                },
                "cons": {
                    "$ref": "#/$defs/two_connections"
                },
                "user_data": {
                    "$ref": "#/$defs/user_data"
                },
                "in_service": {"$ref": "#/$defs/in_service"},
                "vector_group": {
                    "type": "string"
                },
                "n_winding_pairs": {
                    "$ref": "#/$defs/positive_number"
                },
                "is_grounded_p": {
                    "type": "boolean"
                },
                "is_grounded_s": {
                    "type": "boolean"
                },
                "nom_turns_ratio": {
                    "$ref": "#/$defs/complex_number"
                },
                "v_winding_base": {
                    "$ref": "#/$defs/two_positive_number_array"
                },
                "z_p": {
                    "$ref": "#/$defs/complex_number"
                },
                "z_s": {
                    "$ref": "#/$defs/complex_number"
                },
                "z0_p": {
                    "$ref": "#/$defs/complex_number"
                },
                "z0_s": {
                    "$ref": "#/$defs/complex_number"
                },
                "s_max": {
                    "type": "number"
                },
                "tap_range": {
                    "$ref": "#/$defs/two_number_array"
                },
                "tap_factor": {
                    "type": "number"
                },
                "tap_side": {
                    "enum": ["primary", "secondary"]
                },
                "tap_changer": {
                    "$ref": "#/$defs/tap_changer"
                },
                "taps": {
                    "type": "array",
                    "items": {
                        "type": "number"
                    }
                }
            },
            "allOf": [
                {
                    "required": ["id", "type", "cons", "vector_group", "nom_turns_ratio", "v_winding_base"]
                },
                {
                    "anyOf": [
                        {
                            "required": ["z_p"]
                        },
                        {
                            "required": ["z_s"]
                        }
                    ]
                }
            ]
        }
    }
}
